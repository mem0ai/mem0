import pytest
import requests
import json
import time
import asyncio
from typing import Dict, Any

BASE_URL = "http://localhost:8765"  # Lok√°ln√≠ OpenMemory server


class TestSSESessionAddMemories:
    """Testy pro SSE session s add_memories funkc√≠ podle MCP protokolu"""
    
    def setup_method(self):
        """Setup pro ka≈æd√Ω test"""
        self.client_name = "cursor"  # Podle log≈Ø: /mcp/cursor/sse/rmatena
        self.user_id = "rmatena"     # Podle log≈Ø: /mcp/cursor/sse/rmatena
        self.sse_url = f"{BASE_URL}/mcp/{self.client_name}/sse/{self.user_id}"
        self.messages_url = f"{BASE_URL}/mcp/{self.client_name}/sse/{self.user_id}/messages/"
        self.session_id = None  # Bude nastaveno p≈ôi inicializaci
    
    def test_sse_connection_establishment(self):
        """Test vytvo≈ôen√≠ SSE spojen√≠"""
        try:
            with requests.get(self.sse_url, stream=True, timeout=5) as resp:
                assert resp.status_code == 200
                assert resp.headers.get('content-type', '').startswith('text/event-stream')
                print(f"‚úÖ SSE connection established: {resp.status_code}")
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
    
    def test_mcp_initialization_handshake_with_session_id(self):
        """Test MCP initialization handshake s z√≠sk√°n√≠m session_id"""
        try:
            # 1. Vytvo≈ô√≠ SSE spojen√≠
            with requests.get(self.sse_url, stream=True, timeout=5) as sse_resp:
                assert sse_resp.status_code == 200
                
                # 2. Po≈°le MCP initialization zpr√°vu
                init_payload = {
                    "jsonrpc": "2.0",
                    "id": 1,
                    "method": "initialize",
                    "params": {
                        "protocolVersion": "2024-11-05",
                        "capabilities": {
                            "tools": {}
                        },
                        "clientInfo": {
                            "name": self.client_name,
                            "version": "1.0.0"
                        }
                    }
                }
                
                print(f"üì§ Odes√≠l√°m MCP initialization: {json.dumps(init_payload, indent=2)}")
                resp = requests.post(self.messages_url, json=init_payload)
                assert resp.status_code == 200
                
                # 3. Z√≠sk√° session_id z odpovƒõdi
                response_data = resp.json()
                print(f"üì• MCP initialization response: {json.dumps(response_data, indent=2)}")
                
                # Ovƒõ≈ô√≠, ≈æe odpovƒõƒè obsahuje session_id
                if 'result' in response_data and 'sessionId' in response_data['result']:
                    self.session_id = response_data['result']['sessionId']
                    print(f"‚úÖ Session ID z√≠sk√°n z odpovƒõdi: {self.session_id}")
                elif 'result' in response_data:
                    # Zkus√≠ naj√≠t session_id v jin√Ωch m√≠stech odpovƒõdi
                    result = response_data['result']
                    if isinstance(result, dict):
                        # Hled√° session_id v cel√©m result objektu
                        for key, value in result.items():
                            if 'session' in key.lower() or 'id' in key.lower():
                                print(f"üîç Nalezen potenci√°ln√≠ session ID v kl√≠ƒçi '{key}': {value}")
                        
                        # Fallback - pou≈æije se kombinace client_name a user_id
                        self.session_id = f"{self.client_name}_{self.user_id}"
                        print(f"‚ö†Ô∏è Session ID nen√≠ v result.sessionId, pou≈æije se fallback: {self.session_id}")
                    else:
                        self.session_id = f"{self.client_name}_{self.user_id}"
                        print(f"‚ö†Ô∏è Neoƒçek√°van√Ω form√°t result, pou≈æije se fallback: {self.session_id}")
                else:
                    # Fallback - pou≈æije se kombinace client_name a user_id
                    self.session_id = f"{self.client_name}_{self.user_id}"
                    print(f"‚ö†Ô∏è ≈Ω√°dn√Ω result v odpovƒõdi, pou≈æije se fallback: {self.session_id}")
                
                print(f"üéØ Pou≈æ√≠v√°m session_id: {self.session_id}")
                
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
        except json.JSONDecodeError as e:
            print(f"‚ùå Chyba p≈ôi parsov√°n√≠ JSON odpovƒõdi: {e}")
            print(f"üì• Raw response: {resp.text}")
            pytest.fail(f"Nevalidn√≠ JSON odpovƒõƒè: {e}")
    
    def test_tools_list_request_with_session_id(self):
        """Test z√≠sk√°n√≠ seznamu dostupn√Ωch n√°stroj≈Ø s session_id"""
        try:
            # Nejd≈ô√≠ve z√≠sk√° session_id
            self.test_mcp_initialization_handshake_with_session_id()
            
            with requests.get(self.sse_url, stream=True, timeout=5) as sse_resp:
                assert sse_resp.status_code == 200
                
                # Po≈°le request na seznam n√°stroj≈Ø s session_id
                tools_payload = {
                    "jsonrpc": "2.0",
                    "id": 2,
                    "method": "tools/list",
                    "params": {
                        "sessionId": self.session_id
                    }
                }
                
                resp = requests.post(self.messages_url, json=tools_payload)
                assert resp.status_code == 200
                
                # Ovƒõ≈ô√≠, ≈æe odpovƒõƒè obsahuje add_memories n√°stroj
                response_data = resp.json()
                print(f"‚úÖ Tools list response: {response_data}")
                
                # Kontroluje, ≈æe add_memories n√°stroj je dostupn√Ω
                if 'result' in response_data and 'tools' in response_data['result']:
                    tools = response_data['result']['tools']
                    add_memories_tool = next((tool for tool in tools if tool.get('name') == 'add_memories'), None)
                    assert add_memories_tool is not None, "add_memories n√°stroj nen√≠ dostupn√Ω"
                    print(f"‚úÖ add_memories tool found: {add_memories_tool}")
                
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
    
    def test_add_memories_with_session_id(self):
        """Test add_memories s session_id podle MCP protokolu"""
        try:
            # Nejd≈ô√≠ve z√≠sk√° session_id
            self.test_mcp_initialization_handshake_with_session_id()
            
            with requests.get(self.sse_url, stream=True, timeout=5) as sse_resp:
                assert sse_resp.status_code == 200
                
                # Testovac√≠ zpr√°va
                test_text = "Toto je testovac√≠ zpr√°va z SSE session pro Python projekty"
                
                # Po≈°le add_memories request s session_id
                add_memories_payload = {
                    "jsonrpc": "2.0",
                    "id": 3,
                    "method": "tools/call",
                    "params": {
                        "name": "add_memories",
                        "arguments": {
                            "text": test_text
                        },
                        "sessionId": self.session_id
                    }
                }
                
                resp = requests.post(self.messages_url, json=add_memories_payload)
                assert resp.status_code == 200
                
                response_data = resp.json()
                print(f"‚úÖ add_memories response: {response_data}")
                
                # Ovƒõ≈ô√≠, ≈æe context variables funguj√≠ (≈æ√°dn√° chyba o chybƒõj√≠c√≠m user_id/client_name)
                if 'error' in response_data:
                    error_msg = response_data['error'].get('message', '')
                    assert "user_id not provided" not in error_msg, f"Context variables nefunguj√≠: {error_msg}"
                    assert "client_name not provided" not in error_msg, f"Context variables nefunguj√≠: {error_msg}"
                
                # Ovƒõ≈ô√≠, ≈æe operace byla √∫spƒõ≈°n√°
                if 'result' in response_data:
                    result = response_data['result']
                    assert isinstance(result, dict) or isinstance(result, str), f"Neoƒçek√°van√Ω form√°t v√Ωsledku: {result}"
                    print(f"‚úÖ add_memories successful: {result}")
                
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
    
    def test_search_memory_with_session_id(self):
        """Test search_memory s session_id podle MCP protokolu"""
        try:
            # Nejd≈ô√≠ve z√≠sk√° session_id
            self.test_mcp_initialization_handshake_with_session_id()
            
            with requests.get(self.sse_url, stream=True, timeout=5) as sse_resp:
                assert sse_resp.status_code == 200
                
                # Poƒçk√° na indexaci p≈ôedchoz√≠ho add_memories
                time.sleep(2)
                
                # Po≈°le search_memory request s session_id
                search_payload = {
                    "jsonrpc": "2.0",
                    "id": 4,
                    "method": "tools/call",
                    "params": {
                        "name": "search_memory",
                        "arguments": {
                            "query": "Python projekty"
                        },
                        "sessionId": self.session_id
                    }
                }
                
                resp = requests.post(self.messages_url, json=search_payload)
                assert resp.status_code == 200
                
                response_data = resp.json()
                print(f"‚úÖ search_memory response: {response_data}")
                
                # Ovƒõ≈ô√≠, ≈æe context variables funguj√≠
                if 'error' in response_data:
                    error_msg = response_data['error'].get('message', '')
                    assert "user_id not provided" not in error_msg, f"Context variables nefunguj√≠: {error_msg}"
                    assert "client_name not provided" not in error_msg, f"Context variables nefunguj√≠: {error_msg}"
                
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
    
    def test_complete_sse_session_flow_with_session_id(self):
        """Test kompletn√≠ho flow SSE session s session_id podle MCP protokolu"""
        try:
            print(f"\nüöÄ Spou≈°t√≠m kompletn√≠ SSE session flow pro {self.client_name}/{self.user_id}")
            
            # 1. Vytvo≈ô√≠ SSE session
            with requests.get(self.sse_url, stream=True, timeout=5) as sse_resp:
                assert sse_resp.status_code == 200
                print(f"‚úÖ SSE connection established: {sse_resp.status_code}")
                
                # 2. MCP initialization - z√≠sk√°n√≠ session_id
                init_payload = {
                    "jsonrpc": "2.0",
                    "id": 1,
                    "method": "initialize",
                    "params": {
                        "protocolVersion": "2024-11-05",
                        "capabilities": {"tools": {}},
                        "clientInfo": {"name": self.client_name, "version": "1.0.0"}
                    }
                }
                
                print(f"üì§ Odes√≠l√°m MCP initialization...")
                init_resp = requests.post(self.messages_url, json=init_payload)
                assert init_resp.status_code == 200
                
                # Z√≠sk√° session_id z odpovƒõdi
                init_data = init_resp.json()
                print(f"üì• MCP initialization response: {json.dumps(init_data, indent=2)}")
                
                if 'result' in init_data and 'sessionId' in init_data['result']:
                    self.session_id = init_data['result']['sessionId']
                    print(f"‚úÖ Session ID z√≠sk√°n z odpovƒõdi: {self.session_id}")
                elif 'result' in init_data:
                    # Hled√° session_id v result objektu
                    result = init_data['result']
                    if isinstance(result, dict):
                        for key, value in result.items():
                            if 'session' in key.lower() or 'id' in key.lower():
                                print(f"üîç Nalezen potenci√°ln√≠ session ID v kl√≠ƒçi '{key}': {value}")
                    
                    self.session_id = f"{self.client_name}_{self.user_id}"
                    print(f"‚ö†Ô∏è Session ID nen√≠ v result.sessionId, pou≈æije se fallback: {self.session_id}")
                else:
                    self.session_id = f"{self.client_name}_{self.user_id}"
                    print(f"‚ö†Ô∏è ≈Ω√°dn√Ω result v odpovƒõdi, pou≈æije se fallback: {self.session_id}")
                
                print(f"üéØ Pou≈æ√≠v√°m session_id: {self.session_id}")
                
                # 3. Z√≠sk√° seznam n√°stroj≈Ø s session_id
                tools_payload = {
                    "jsonrpc": "2.0",
                    "id": 2,
                    "method": "tools/list",
                    "params": {
                        "sessionId": self.session_id
                    }
                }
                
                print(f"üì§ Odes√≠l√°m tools/list s session_id: {self.session_id}")
                tools_resp = requests.post(self.messages_url, json=tools_payload)
                assert tools_resp.status_code == 200
                
                tools_data = tools_resp.json()
                print(f"üì• Tools list response: {json.dumps(tools_data, indent=2)}")
                
                # 4. P≈ôid√° vzpom√≠nku s session_id
                test_text = "Kompletn√≠ test SSE session flow - u≈æivatel pracuje s Python projekty"
                add_payload = {
                    "jsonrpc": "2.0",
                    "id": 3,
                    "method": "tools/call",
                    "params": {
                        "name": "add_memories",
                        "arguments": {
                            "text": test_text
                        },
                        "sessionId": self.session_id
                    }
                }
                
                print(f"üì§ Odes√≠l√°m add_memories s session_id: {self.session_id}")
                print(f"üìù Text: {test_text}")
                add_resp = requests.post(self.messages_url, json=add_payload)
                assert add_resp.status_code == 200
                
                add_data = add_resp.json()
                print(f"üì• add_memories response: {json.dumps(add_data, indent=2)}")
                
                # 5. Poƒçk√° na indexaci
                print("‚è≥ ƒåek√°m na indexaci...")
                time.sleep(2)
                
                # 6. Vyhled√° vzpom√≠nky s session_id
                search_payload = {
                    "jsonrpc": "2.0",
                    "id": 4,
                    "method": "tools/call",
                    "params": {
                        "name": "search_memory",
                        "arguments": {
                            "query": "Python"
                        },
                        "sessionId": self.session_id
                    }
                }
                
                print(f"üì§ Odes√≠l√°m search_memory s session_id: {self.session_id}")
                search_resp = requests.post(self.messages_url, json=search_payload)
                assert search_resp.status_code == 200
                
                search_data = search_resp.json()
                print(f"üì• search_memory response: {json.dumps(search_data, indent=2)}")
                
                print(f"‚úÖ Kompletn√≠ SSE session flow √∫spƒõ≈°n√Ω s session_id: {self.session_id}")
                
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
        except json.JSONDecodeError as e:
            print(f"‚ùå Chyba p≈ôi parsov√°n√≠ JSON odpovƒõdi: {e}")
            pytest.fail(f"Nevalidn√≠ JSON odpovƒõƒè: {e}")
    
    def test_session_id_isolation(self):
        """Test izolace session_id mezi r≈Øzn√Ωmi session"""
        try:
            print(f"\nüîí Testuji izolaci session_id mezi r≈Øzn√Ωmi session")
            
            # Vytvo≈ô√≠ dvƒõ r≈Øzn√© session
            session1_url = f"{BASE_URL}/mcp/client1/sse/user1"
            session2_url = f"{BASE_URL}/mcp/client2/sse/user2"
            
            session1_id = None
            session2_id = None
            
            # Session 1 - z√≠sk√°n√≠ session_id
            print(f"üì° Session 1: {session1_url}")
            with requests.get(session1_url, stream=True, timeout=5) as sse1:
                assert sse1.status_code == 200
                
                init_payload = {
                    "jsonrpc": "2.0",
                    "id": 1,
                    "method": "initialize",
                    "params": {
                        "protocolVersion": "2024-11-05",
                        "capabilities": {"tools": {}},
                        "clientInfo": {"name": "client1", "version": "1.0.0"}
                    }
                }
                
                print(f"üì§ Session 1 - odes√≠l√°m MCP initialization...")
                resp1 = requests.post(f"{BASE_URL}/mcp/client1/sse/user1/messages/", json=init_payload)
                assert resp1.status_code == 200
                
                init_data1 = resp1.json()
                print(f"üì• Session 1 - MCP initialization response: {json.dumps(init_data1, indent=2)}")
                
                if 'result' in init_data1 and 'sessionId' in init_data1['result']:
                    session1_id = init_data1['result']['sessionId']
                    print(f"‚úÖ Session 1 - Session ID z√≠sk√°n: {session1_id}")
                else:
                    session1_id = "client1_user1"
                    print(f"‚ö†Ô∏è Session 1 - Session ID nen√≠ v odpovƒõdi, pou≈æije se fallback: {session1_id}")
            
            # Session 2 - z√≠sk√°n√≠ session_id
            print(f"üì° Session 2: {session2_url}")
            with requests.get(session2_url, stream=True, timeout=5) as sse2:
                assert sse2.status_code == 200
                
                init_payload = {
                    "jsonrpc": "2.0",
                    "id": 1,
                    "method": "initialize",
                    "params": {
                        "protocolVersion": "2024-11-05",
                        "capabilities": {"tools": {}},
                        "clientInfo": {"name": "client2", "version": "1.0.0"}
                    }
                }
                
                print(f"üì§ Session 2 - odes√≠l√°m MCP initialization...")
                resp2 = requests.post(f"{BASE_URL}/mcp/client2/sse/user2/messages/", json=init_payload)
                assert resp2.status_code == 200
                
                init_data2 = resp2.json()
                print(f"üì• Session 2 - MCP initialization response: {json.dumps(init_data2, indent=2)}")
                
                if 'result' in init_data2 and 'sessionId' in init_data2['result']:
                    session2_id = init_data2['result']['sessionId']
                    print(f"‚úÖ Session 2 - Session ID z√≠sk√°n: {session2_id}")
                else:
                    session2_id = "client2_user2"
                    print(f"‚ö†Ô∏è Session 2 - Session ID nen√≠ v odpovƒõdi, pou≈æije se fallback: {session2_id}")
            
            # Ovƒõ≈ô√≠, ≈æe session_id jsou r≈Øzn√©
            print(f"\nüîç Porovn√°v√°m session_id:")
            print(f"   Session 1: {session1_id}")
            print(f"   Session 2: {session2_id}")
            
            assert session1_id != session2_id, f"Session ID by mƒõly b√Ωt r≈Øzn√©: {session1_id} vs {session2_id}"
            print(f"‚úÖ Session ID isolation √∫spƒõ≈°n√°: {session1_id} vs {session2_id}")
            
        except requests.exceptions.RequestException as e:
            pytest.skip(f"OpenMemory server not running: {e}")
        except json.JSONDecodeError as e:
            print(f"‚ùå Chyba p≈ôi parsov√°n√≠ JSON odpovƒõdi: {e}")
            pytest.fail(f"Nevalidn√≠ JSON odpovƒõƒè: {e}")

    def test_sse_session_establishment_and_mcp_tools(self):
        """Test SSE session establishment a MCP n√°stroj≈Ø podle skuteƒçn√Ωch log≈Ø"""
        try:
            print(f"\nüöÄ Testuji SSE session establishment pro {self.client_name}/{self.user_id}")
            
            # 1. SSE session establishment p≈ôes GET request (jako v logu)
            sse_url = f"{BASE_URL}/mcp/{self.client_name}/sse/{self.user_id}"
            print(f"üì° SSE URL: {sse_url}")
            
            # Simuluje GET request jako v logu: GET /mcp/cursor/sse/rmatena HTTP/1.1" 200 OK
            with requests.get(sse_url, stream=True, timeout=10) as sse_resp:
                print(f"üì° SSE Response Status: {sse_resp.status_code}")
                print(f"üì° SSE Response Headers: {dict(sse_resp.headers)}")
                
                assert sse_resp.status_code == 200, f"SSE session establishment failed: {sse_resp.status_code}"
                print("‚úÖ SSE session established successfully (200 OK)")
                
                # 2. MCP initialization handshake
                print(f"\nüì§ Odes√≠l√°m MCP initialization...")
                init_payload = {
                    "jsonrpc": "2.0",
                    "id": 1,
                    "method": "initialize",
                    "params": {
                        "protocolVersion": "2024-11-05",
                        "capabilities": {"tools": {}},
                        "clientInfo": {"name": self.client_name, "version": "1.0.0"}
                    }
                }
                
                messages_url = f"{BASE_URL}/mcp/{self.client_name}/sse/{self.user_id}/messages/"
                print(f"üì§ Messages URL: {messages_url}")
                
                init_resp = requests.post(messages_url, json=init_payload, timeout=10)
                print(f"üì§ MCP Init Response Status: {init_resp.status_code}")
                
                if init_resp.status_code == 200:
                    init_data = init_resp.json()
                    print(f"üì• MCP Init Response: {json.dumps(init_data, indent=2)}")
                    
                    # Z√≠sk√° session_id z odpovƒõdi nebo pou≈æije fallback
                    if 'result' in init_data and 'sessionId' in init_data['result']:
                        self.session_id = init_data['result']['sessionId']
                        print(f"‚úÖ Session ID z√≠sk√°n: {self.session_id}")
                    else:
                        self.session_id = f"{self.client_name}_{self.user_id}"
                        print(f"‚ö†Ô∏è Session ID fallback: {self.session_id}")
                    
                    # 3. Test add_memories n√°stroje
                    print(f"\nüì§ Testuji add_memories n√°stroj...")
                    test_text = "Testovac√≠ zpr√°va z pytest: U≈æivatel pracuje s Python projekty a testuje OpenMemory MCP n√°stroje"
                    
                    add_payload = {
                        "jsonrpc": "2.0",
                        "id": 2,
                        "method": "tools/call",
                        "params": {
                            "name": "add_memories",
                            "arguments": {
                                "text": test_text
                            },
                            "sessionId": self.session_id
                        }
                    }
                    
                    print(f"üì§ Add Memories Payload: {json.dumps(add_payload, indent=2)}")
                    add_resp = requests.post(messages_url, json=add_payload, timeout=10)
                    print(f"üì§ Add Memories Response Status: {add_resp.status_code}")
                    
                    if add_resp.status_code == 200:
                        add_data = add_resp.json()
                        print(f"üì• Add Memories Response: {json.dumps(add_data, indent=2)}")
                        
                        # Ovƒõ≈ô√≠ v√Ωsledek
                        if 'result' in add_data:
                            print(f"‚úÖ add_memories √∫spƒõ≈°n√©: {add_data['result']}")
                        elif 'error' in add_data:
                            print(f"‚ùå add_memories chyba: {add_data['error']}")
                        else:
                            print(f"‚ö†Ô∏è Neoƒçek√°van√° odpovƒõƒè: {add_data}")
                    else:
                        print(f"‚ùå add_memories request failed: {add_resp.status_code}")
                        print(f"‚ùå Response: {add_resp.text}")
                    
                    # 4. Test search_memory n√°stroje
                    print(f"\nüì§ Testuji search_memory n√°stroj...")
                    time.sleep(2)  # Poƒçk√° na indexaci
                    
                    search_payload = {
                        "jsonrpc": "2.0",
                        "id": 3,
                        "method": "tools/call",
                        "params": {
                            "name": "search_memory",
                            "arguments": {
                                "query": "Python projekty"
                            },
                            "sessionId": self.session_id
                        }
                    }
                    
                    print(f"üì§ Search Memory Payload: {json.dumps(search_payload, indent=2)}")
                    search_resp = requests.post(messages_url, json=search_payload, timeout=10)
                    print(f"üì§ Search Memory Response Status: {search_resp.status_code}")
                    
                    if search_resp.status_code == 200:
                        search_data = search_resp.json()
                        print(f"üì• Search Memory Response: {json.dumps(search_data, indent=2)}")
                        
                        if 'result' in search_data:
                            print(f"‚úÖ search_memory √∫spƒõ≈°n√©: {search_data['result']}")
                        elif 'error' in search_data:
                            print(f"‚ùå search_memory chyba: {search_data['error']}")
                    else:
                        print(f"‚ùå search_memory request failed: {search_resp.status_code}")
                        print(f"‚ùå Response: {search_resp.text}")
                        
                else:
                    print(f"‚ùå MCP initialization failed: {init_resp.status_code}")
                    print(f"‚ùå Response: {init_resp.text}")
                    
        except requests.exceptions.RequestException as e:
            print(f"‚ùå Network error: {e}")
            pytest.skip(f"OpenMemory server not running: {e}")
        except Exception as e:
            print(f"‚ùå Unexpected error: {e}")
            import traceback
            traceback.print_exc()
            pytest.fail(f"Test failed: {e}")


if __name__ == "__main__":
    # Spust√≠ testy
    pytest.main([__file__, "-v"]) 